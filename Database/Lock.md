# Lock 관련

## MySQL의 Lock

- MySQL에서의 락은 **MySQL 엔진레벨**과 **스토리지 엔진 레벨**로 나눌 수 있다.
- MySQL 엔진레벨 잠금 -> 스토리지 엔진에 영향
- 스토리지 엔진레벨 잠금 -> 스토리지 엔진 상호간 영향 X

## 글로벌 락

```sql
FLUSH TABLES WITH READ LOCK
```
- 해당 명령어만으로 글로벌 락 획득 가능
- MySQL 제공해주는 락 중 가장 범위가 크다. (MySQL 서버 전체)
  - 테이블, 데이터베이스(스키마)가 달라도 동일한 영향을 받는다.
- 해당 명령어를 실행할 때 이전에 먼저 실행된 SQL이 실행 완료되어야 한다.
  - `이전 쿼리가 장기화 + FLUSH 명령`이 최악의 케이스로 실행되면 장시간 INSERT, UPDATE, DELETE 쿼리가 실행되지 못하는 상태에 놓일 수 있다.
- `mysqldump`같은 일관된 백업 작업을 할 때 글로벌 락 사용

## 테이블 락
- 개별 테이블 단위로 설정되는 잠금
- 명시적 테이블 락, 묵시적 테이블 락으로 나뉨

### 명시적 테이블 락
```sql
LOCK TABLES table_name [READ | WRITE]
...
UNLOCK TABLES
```
- MyISAM, InnoDB 스토리지 엔진에서 동일하게 설정 가능
- 명시적인 방법으로 락을 걸면 명시적으로 락을 해제해야 함
- 애플리케이션에서는 특별한 상황이 아니라면 사용 X
  - 글로벌 락과 비슷하게 애플리케이션 작업에 상당한 영향을 미치기 때문

### 묵시적 테이블 락
- 주로 MyISAM, Memory 테이블에 데이터 변경하는 쿼리 실행시 묵시적으로 발생
  - 1. MySQL 서버가 데이터가 변경되는 테이블에 잠금 설정
  - 2. 이후 데이터 변경 작업
  - 3. 즉시 잠금 해제
- 쿼리가 실행되는 동안 자동적으로 획득됐다가 완료된 후 자동 해제
- **InnoDB에서는 스토리지 엔진 차원에서 레코드 락을 제공하기 때문에 묵시적 테이블 락 불필요**
  - 대부분의 데이터 변경(DML) 쿼리에서는 무시
  - InnoDB에서는 스키마를 변경하는 DDL 쿼리의 경우에만 묵시적 테이블 락 영향을 받음
