# HTTPS

- HTTP의 암호화된 protocol 버전
- 클라이언트, 서버 간에 모든 통신을 암호화하기 위해 SSL이나 TLS를 사용
- SSL (Secure Sockets Layer)
  - 과거 보안 표준 기술
- [TLS](https://ko.wikipedia.org/wiki/%EC%A0%84%EC%86%A1_%EA%B3%84%EC%B8%B5_%EB%B3%B4%EC%95%88) (Transport Layer Security)

## 📌 HTTPS 내용
```text
HTTP -- *SSL/TLS* -- TCP -- IP -- Network Interface
```
- HTTP를 TCP 계층에 보내기전에 보안계층을 거치게 됨
- 보안계층은 SSL(Secure Sockets Layer)과 현대 대체품인 TLS(Transport Layer Security)로 구현  
  (통상적으로 SSL, TLS 합쳐 SSL이라 부름)
- URL은 `https`라는 스킴을 통해 HTTPS를 사용한다.
  - 이 때 클라이언트는 서버의 `443`(기본값) 포트로 연결
  - handshake가 이루어지고 암호화된 HTTP 명령이 뒤따름


## SSL, TLS

### SSL
- 웹에서 전송되는 데이터를 암호화한다.  
  중간에서 데이터를 가로채도 해독할 수 없는 복잡한 문자만 보이게 됨
- 데이터 무결성을 제공, 데이터에 디지털 서명을 하여 의도된 수신자에게 도착하기 전에 위변조되지 않았음을 확인
- SSL 2.0에서 취약점이 발견되었고 3.0에서 개선
  - 2.0은 MITM(man-in-the-middle) 유형의 공격에 취약하다는 점이 드러남. 
  - 이로 인해 SSL 핸드쉐이크 과정 중 제 3자에게 노출이 되어 권한이 없는 사람이 SSL 세션키를 해독할 가능성이 생겼음
  - 3.0은 이런 MITM 유형의 공격을 감소시킴.
  - 3.0에서 SHA-1 해싱 알고리즘을 Cipher Suite에서 제공
### TLS
- SSL 3.0 -> TLS 1.0 (SSL의 새로운 버전)
- 통상적으로 SSL이라고 부른다.
- HMAC(Key-Hashing for Message Authentication Code) 방식을 사용함으로써 개방 네트워크에서 레코드를 변경할 수 없도록 함  
  - SSL 3.0에서의 메시지 인증코드(MAC) 기능보다 안전

## 📌 SSL에 사용되는 암호법

- 대칭키 암호법
  - 인코딩과 디코딩에 같은 키를 사용
  - 같은 키를 사용하기에 절대로 누설되면 안됨
  - 발송자, 수신자가 서로 대화하기 위해서 같은 공유키를 가져야함
  - A, B, C -> Z와 통신하려면 AZ, BZ, CZ 간의 연결을 위한 공유키를 각각 생성해야 함(비효율적)
- 공개키 암호법(비대칭키)
  - 인코딩 키는 모두를 위해 공개(공개키), 디코딩 키는 호스트만이 가지고 있음
  - A, B, C -> Z로 메시지를 보낼 때 Z의 공개키 하나만으로 가능
  - 공개키 방식의 알고리즘은 계산이 느려 성능상 이슈가 발생할 수 있음  
    (**실제로 공개키, 대칭키 방식 혼합해서 사용**)

## 📌 SSL Hanshake

TCP handshake과정을 먼저 거친 후에 SSL handshake가 진행

- 공개키 방식은 컴퓨팅 파워가 많이 필요하기에 성능상의 이슈가 발생할 수 있음
- 대칭키는 하나의 키로 인증 작업을 진행하기에 컴퓨팅 파워가 공개키 방식보다 덜 필요
- 이렇기에 SSL handshake에서는 대칭키 방식, 공개키 방식을 혼합해서 사용하는 방식을 선택

### 🔐 handshake 과정

1. 클라이언트가 암호 후보들을 보내고 인증서를 요구
2. 서버는 선택된 암호와 인증서를 클라이언트에게 보냄
3. 클라이언트가 비밀정보를 보냄, 클라이언트와 서버는 키를 만듬(대칭키)
4. 클라이언트와 서버는 서로 암호화를 시작한다고 알림

#### 1. Client Hello

> 클라이언트에서 서버로 전송하는 내용

- 클라이언트에서 생성한 랜덤 데이터
- 클라이언트가 지원하는 암호화 방식 리스트
  - 클라이언트가 소화할 수 있는 암호화 기법이 무엇인지를 서버에 알려주기 위해 리스트업을 보내게 된다. (`Cipher Suite` 목록)
  - 서버마다 소화가능한 암호화 기법이 다 다르기 때문에 이를 조율하는 과정이 필요  
    (클라이언트 - 서버 간 협상 필요)
- 세션 아이디 (중요하진 않음)
  - 이미 SSL handshake를 한 상황이라면, 기존의 세션을 재활용하기 위해 사용할 연결에 대한 식별자

#### 2. Server Hello

> 클라이언트로부터 받은 데이터들을 기반으로 서버가 다시 클라이언트로 전송하는 내용

- 서버 측에서 생성한 랜덤 데이터
- 서버가 선택한 클라이언트 암호화 방식
  - 클라이언트에서 보내준 `Cipher Suite` 목록을 기반으로 가장 안전하면서도 서버측에서 소화 가능한 암호화 기법을 선택
  - 클라이언트와 협상 과정

#### 3. Certificate
> 서버는 서버 인증서를 클라이언트에게 전달해주고 해당 인증서가 공인된 CA로부터 발급된 인증서인지 확인하는 작업이 이루어진다.

- **인증서**
  - **가장 중요, CA(Certificate Authority) 개인키로 암호화된 상태**
  - 인증서를 클라이언트로 보낸다.
  - 인증서 안에는 서버의 공개키를 포함하고 있음
- 서버로부터 전송받은 CA 인증서에 대한 확인
  - CA 공개키를 가지고 서버가 보내준 인증서에 대한 복호화 시도  
    (브라우저는 신뢰할만한 서명기관에 대한 공개키를 이미 가지고 있음)
  - 복호환된 인증서 내용을 기반으로 클라이언트에 내장된 CA 리스트들을 확인  
    (브라우저들은 여러 서명 기관의 인증서가 미리 설치된 채로 출하)
  - 인증서가 없다면 사용자에게 경고 매세지 출력
- `pre master secret` 생성
  - 클라이언트가 생성한 랜덤데이터 + 서버가 보내준 랜더데이터를 조합한 키
  - 세션 단계에서 데이터를 주고 받을 때 사용
  - 여기서 **대칭키 암호법**을 사용하는데 대칭키이기 때문에 절대로 3자에게 유출되면 안되는 정보


#### 4. (Server Key Exchange), Server Hello Done
- 만약 인증서 내부에 서버 공개키가 없다면 서버가 직접 전달해주는 단계가 `Server Key Exchange`  
- 공개키가 담겨져 있으면 해당 단계는 생략
- 이후 Server의 행동이 완료되었음을 알리는 `Server Hello Done`

#### 5. Client Key Exchange
- `pre master secret`을 서버의 공개키로 암호화
- 암호화된 `pre master secret`을 서버에 전송

#### 6. Changed Cipher Spec, Finished
- 서로 통신할 준비가 완료되었음을 알리는 패킷을 클라이언트, 서버간 교환

### 🔐 세션 키 공유

- 위의 과정을 거쳐서 클라이언트, 서버는 양측에 동일한 대칭키를 가지게 됨
- `pre master secret` -> `master secret` -> **`session key`** 생성
- **session key** 값을 통해 대칭키 방식으로 데이터를 암호화한 후 클라이언트, 서버간 통신이 이루어짐

### 🔐 세션 종료
- 데이터 전송이 완료되면 SSL 통신이 끝났음을 서로 알리게 됨
- 사용했던 세션 키(대칭키)를 폐기

### 🔐 SSL handshake 정리
- TCP handshake 이후 이루어지는 과정
- 결국 클라이언트, 서버간 보안 안정적인 대칭키 방식의 데이터 교환을 보장하기 위해 대칭키를 서로 교환하는 과정
- 대칭키를 교환하는 것은 통신 과정 중간에 가로챌 리스크가 있기 때문에 처음에 교환하는 과정에서 공개키 방식을 사용
- 처음 연결 때 공개키 방식을 사용하고 연결된 이후에 데이터 교환에는 대칭키 방식을 사용하게 됨으로써 효율적인 통신이 이루어짐

## 📌 References

- [HTTPS 통신과정 쉽게 이해하기(SSL Handshake)](https://aws-hyoh.tistory.com/entry/HTTPS-%ED%86%B5%EC%8B%A0%EA%B3%BC%EC%A0%95-%EC%89%BD%EA%B2%8C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-3SSL-Handshake)