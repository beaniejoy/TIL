# HTTPS

- HTTP의 암호화된 protocol 버전
- 클라이언트, 서버 간에 모든 통신을 암호화하기 위해 SSL이나 TLS를 사용
- SSL (Secure Sockets Layer)
  - 과거 보안 표준 기술
- [TLS](https://ko.wikipedia.org/wiki/%EC%A0%84%EC%86%A1_%EA%B3%84%EC%B8%B5_%EB%B3%B4%EC%95%88) (Transport Layer Security)

## HTTPS handshake (SSL handshake)

TCP handshake과정을 먼저 거친 후에 SSL handshake가 진행

### 공개키, 대칭키

- 실제 데이터: 대칭키 사용
- 대칭키의 키: 공개키 사용

공개키 방식은 컴퓨팅 파워가 많이 필요하기에 성능상의 이슈가 발생할 수 있다. 대칭키는 하나의 키로 인증 작업을 진행하기에 컴퓨팅 파워가 공개키 방식보다 덜 필요하다. 이렇기에 SSL handshake에서는 대칭키 방식, 공개키 방식을 혼합해서 사용하는 방식을 선택

### handshake 과정

#### 1. Client Hello

클라이언트에서 서버로 전송하는 내용
- 클라이언트에서 생성한 랜덤 데이터
- 클라이언트가 지원하는 암호화 방식 리스트
  - 클라이언트가 소화할 수 있는 암호화 기법이 무엇인지를 서버에 알려주기 위해 리스트업을 보내게 된다. (`Cipher Suite` 목록)
  - 서버마다 소화가능한 암호화 기법이 다 다르기 때문에 이를 조율하는 과정이 필요(클라이언트 - 서버 간 협상 필요)
- 세션 아이디 (중요하진 않음)
  - 이미 SSL handshake를 한 상황이라면, 기존의 세션을 재활용하기 위해 사용할 연결에 대한 식별자

#### 2. Server Hello

클라이언트로부터 받은 데이터들을 기반으로 서버가 다시 클라이언트로 전송하는 내용
- 서버 측에서 생성한 랜덤 데이터
- 서버가 선택한 클라이언트 암호화 방식
  - 클라이언트에서 보내준 `Cipher Suite` 목록을 기반으로 가장 안전하면서도 서버측에서 소화 가능한 암호화 기법을 선택
  - 클라이언트와 협상 과정
- **인증서** (가장 중요, CA 개인키로 암호화된 상태)

#### 3. Certificate
서버가 보내준 인증서가 공인된 CA로부터 발급된 인증서인지 확인하는 작업이 이루어진다.
- 서버로부터 전송받은 CA 인증서에 대한 확인
  - 클라이언트에 내장된 CA 리스트들을 확인
  - 내장된 CA 공개키를 가지고 서버가 보내준 인증서에 대한 복호화 시도 (서버가 보내준 CA 인증서는 CA 개인키로 암호화되어 있는 상태)
  - 인증서가 없다면 사용자에게 경고 매세지 출력
- `pre master secret` 생성
  - 클라이언트가 생성한 랜덤데이터 + 서버가 생성한 랜더데이터를 조합한 키
  - 세션 단계에서 데이터를 주고 받을 때 사용
  - 여기서 대칭키 방식을 사용하는데 대칭키이기 때문에 절대로 3자에게 유출되면 안되는 정보

#### 4. Server Key Exchange / Server Hello Done
- 만약 인증서 내부에 서버 공개키가 없다면 서버가 직접 전달해주는 단계가 `Server Key Exchange`  
- 공개키가 담겨져 있으면 해당 단계는 생략
- 이후 Server의 행동이 완료되었음을 알리는 `Server Hello Done`

#### 5. Client Key Exchange
- 서버 공개키로 암호화
  - pre master secret을 서버의 공개키로 암호화
  - 서버가 보내준 인증서 내부에 서버의 공개키가 들어있다.
- 암호화된 pre master secret을 서버에 전송

#### 6. Changed Cipher Spec / Finished
- 서로 통신할 준비가 완료되었음을 알리는 패킷을 클라이언트, 서버간 교환

### 세션 키 공유

- 위의 과정을 거쳐서 클라이언트, 서버는 양측에 동일한 대칭키를 가지게 됨
- pre master secret -> master secret -> **session key** 생성
- **session key**값을 통해 대칭키 방식으로 데이터를 암호화한 후 클라이언트, 서버간 통신이 이루어짐

### SSL handshake 정리
- TCP handshake 이후 이루어지는 과정
- 결국 클라이언트, 서버간 보안 안정적인 대칭키 방식의 데이터 교환을 보장하기 위해 대칭키를 서로 교환하는 과정
- 대칭키를 교환하는 것은 통신 과정 중간에 가로챌 리스크가 있기 때문에 처음에 교환하는 과정에서 공개키 방식을 사용
- 처음 연결 때 공개키 방식을 사용하고 연결된 이후에 데이터 교환에는 대칭키 방식을 사용하게 됨으로써 효율적인 통신이 이루어짐

### 세션 종료
- 데이터 전송이 완료되면 SSL 통신이 끝났음을 서로 알리게 됨
- 사용했던 세션 키(대칭키)를 폐기